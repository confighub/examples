#!/bin/bash

# cleanup-crossplane-iam.sh
# Cleans up AWS resources created by setup-crossplane-iam.sh
# Uses the user's default AWS credentials (AWS_PROFILE, etc.)

set -euo pipefail

# Configuration
RESOURCES_FILE="var/aws-resources.json"
CREDENTIALS_FILE="var/aws-credentials.ini"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CROSSPLANE_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check prerequisites
check_prerequisites() {
    log_info "Checking prerequisites..."
    
    # Check if AWS CLI is installed
    if ! command -v aws &> /dev/null; then
        log_error "AWS CLI is not installed. Please install it first."
        exit 1
    fi
    
    # Check if jq is installed
    if ! command -v jq &> /dev/null; then
        log_error "jq is not installed. Please install it first."
        log_info "On macOS: brew install jq"
        log_info "On Ubuntu/Debian: sudo apt-get install jq"
        exit 1
    fi
    
    # Check if resources file exists
    if [[ ! -f "$CROSSPLANE_DIR/$RESOURCES_FILE" ]]; then
        log_error "Resources file '$RESOURCES_FILE' not found."
        log_info "This script can only clean up resources that were created by setup-crossplane-iam.sh"
        exit 1
    fi
    
    # Test AWS credentials
    log_info "Testing AWS credentials..."
    if ! aws sts get-caller-identity &> /dev/null; then
        log_error "AWS credentials are not configured or invalid."
        log_info "Please configure your AWS credentials using:"
        log_info "  aws configure"
        log_info "  or set AWS_PROFILE environment variable"
        exit 1
    fi
    
    # Get AWS account info
    AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
    log_success "AWS credentials validated. Account: $AWS_ACCOUNT_ID"
}

# Load resource information
load_resource_info() {
    log_info "Loading resource information..."
    
    # Read the resources file
    RESOURCES_JSON=$(cat "$CROSSPLANE_DIR/$RESOURCES_FILE")
    
    # Extract resource information
    IAM_USER_NAME=$(echo "$RESOURCES_JSON" | jq -r '.iam_user.name')
    IAM_POLICY_NAME=$(echo "$RESOURCES_JSON" | jq -r '.iam_policy.name')
    IAM_POLICY_ARN=$(echo "$RESOURCES_JSON" | jq -r '.iam_policy.arn')
    CREATED_AT=$(echo "$RESOURCES_JSON" | jq -r '.created_at')
    
    # Validate that we're in the right AWS account
    STORED_ACCOUNT_ID=$(echo "$RESOURCES_JSON" | jq -r '.aws_account_id')
    if [[ "$AWS_ACCOUNT_ID" != "$STORED_ACCOUNT_ID" ]]; then
        log_error "AWS account mismatch!"
        log_error "Current account: $AWS_ACCOUNT_ID"
        log_error "Resources were created in account: $STORED_ACCOUNT_ID"
        exit 1
    fi
    
    log_success "Resource information loaded successfully"
    log_info "Resources created at: $CREATED_AT"
    log_info "IAM User: $IAM_USER_NAME"
    log_info "IAM Policy: $IAM_POLICY_NAME"
}

# Validate resources before cleanup
validate_resources() {
    log_info "Validating resources before cleanup..."
    
    # Extract metadata from resources file
    EXPECTED_RANDOM_SUFFIX=$(echo "$RESOURCES_JSON" | jq -r '.random_suffix')
    
    # Check if the user was created by our setup script (has our tags)
    USER_TAGS=$(aws iam list-user-tags --user-name "$IAM_USER_NAME" --query 'Tags[?Key==`ManagedBy`].Value' --output text 2>/dev/null || echo "")
    USER_RANDOM_SUFFIX=$(aws iam list-user-tags --user-name "$IAM_USER_NAME" --query 'Tags[?Key==`RandomSuffix`].Value' --output text 2>/dev/null || echo "")
    
    if [[ "$USER_TAGS" != "Script" ]] || [[ "$USER_RANDOM_SUFFIX" != "$EXPECTED_RANDOM_SUFFIX" ]]; then
        log_error "IAM user '$IAM_USER_NAME' was not created by this setup script"
        log_error "Expected: ManagedBy=Script, RandomSuffix=$EXPECTED_RANDOM_SUFFIX"
        log_error "Found: ManagedBy=$USER_TAGS, RandomSuffix=$USER_RANDOM_SUFFIX"
        log_error "Refusing to delete user for safety"
        exit 1
    fi
    
    # Check if the policy was created by our setup script (has our tags)
    POLICY_TAGS=$(aws iam list-policy-tags --policy-arn "$IAM_POLICY_ARN" --query 'Tags[?Key==`ManagedBy`].Value' --output text 2>/dev/null || echo "")
    POLICY_RANDOM_SUFFIX=$(aws iam list-policy-tags --policy-arn "$IAM_POLICY_ARN" --query 'Tags[?Key==`RandomSuffix`].Value' --output text 2>/dev/null || echo "")
    
    if [[ "$POLICY_TAGS" != "Script" ]] || [[ "$POLICY_RANDOM_SUFFIX" != "$EXPECTED_RANDOM_SUFFIX" ]]; then
        log_error "IAM policy '$POLICY_NAME' was not created by this setup script"
        log_error "Expected: ManagedBy=Script, RandomSuffix=$EXPECTED_RANDOM_SUFFIX"
        log_error "Found: ManagedBy=$POLICY_TAGS, RandomSuffix=$POLICY_RANDOM_SUFFIX"
        log_error "Refusing to delete policy for safety"
        exit 1
    fi
    
    log_success "All resources validated - they were created by this setup script"
    log_info "Resources created with random suffix: $EXPECTED_RANDOM_SUFFIX"
}

# Delete access keys
delete_access_keys() {
    log_info "Deleting access keys for user: $IAM_USER_NAME"
    
    # Get all access keys for the user
    ACCESS_KEYS=$(aws iam list-access-keys --user-name "$IAM_USER_NAME" --query 'AccessKeyMetadata[].AccessKeyId' --output text)
    
    if [[ -n "$ACCESS_KEYS" ]]; then
        for ACCESS_KEY in $ACCESS_KEYS; do
            log_info "Deleting access key: $ACCESS_KEY"
            aws iam delete-access-key --user-name "$IAM_USER_NAME" --access-key-id "$ACCESS_KEY"
        done
        log_success "All access keys deleted successfully"
    else
        log_info "No access keys found for user"
    fi
}

# Detach and delete policy
delete_policy() {
    log_info "Detaching and deleting policy: $IAM_POLICY_NAME"
    
    # Check if policy exists
    if aws iam get-policy --policy-arn "$IAM_POLICY_ARN" &> /dev/null; then
        # Detach policy from user
        log_info "Detaching policy from user..."
        aws iam detach-user-policy --user-name "$IAM_USER_NAME" --policy-arn "$IAM_POLICY_ARN"
        log_success "Policy detached from user"
        
        # Delete all non-default policy versions
        log_info "Deleting policy versions..."
        POLICY_VERSIONS=$(aws iam list-policy-versions --policy-arn "$IAM_POLICY_ARN" --query 'Versions[?IsDefaultVersion==`false`].VersionId' --output text)
        
        if [[ -n "$POLICY_VERSIONS" ]]; then
            for VERSION in $POLICY_VERSIONS; do
                log_info "Deleting policy version: $VERSION"
                aws iam delete-policy-version --policy-arn "$IAM_POLICY_ARN" --version-id "$VERSION"
            done
        fi
        
        # Delete the policy
        log_info "Deleting policy..."
        aws iam delete-policy --policy-arn "$IAM_POLICY_ARN"
        log_success "Policy deleted successfully"
    else
        log_warning "Policy '$IAM_POLICY_NAME' not found (may have been deleted already)"
    fi
}

# Delete IAM user
delete_iam_user() {
    log_info "Deleting IAM user: $IAM_USER_NAME"
    
    # Check if user exists
    if aws iam get-user --user-name "$IAM_USER_NAME" &> /dev/null; then
        # Delete the user
        aws iam delete-user --user-name "$IAM_USER_NAME"
        log_success "IAM user deleted successfully"
    else
        log_warning "IAM user '$IAM_USER_NAME' not found (may have been deleted already)"
    fi
}

# Clean up local files
cleanup_local_files() {
    log_info "Cleaning up local files..."
    
    # Remove credentials file
    if [[ -f "$CROSSPLANE_DIR/$CREDENTIALS_FILE" ]]; then
        rm "$CROSSPLANE_DIR/$CREDENTIALS_FILE"
        log_success "Credentials file deleted"
    else
        log_info "Credentials file not found"
    fi
    
    # Remove resources file
    if [[ -f "$CROSSPLANE_DIR/$RESOURCES_FILE" ]]; then
        rm "$CROSSPLANE_DIR/$RESOURCES_FILE"
        log_success "Resources file deleted"
    else
        log_info "Resources file not found"
    fi
    
    # Remove var directory if empty
    if [[ -d "$CROSSPLANE_DIR/var" ]] && [[ -z "$(ls -A "$CROSSPLANE_DIR/var" 2>/dev/null)" ]]; then
        rmdir "$CROSSPLANE_DIR/var"
        log_success "Empty var directory removed"
    fi
}

# Display summary
display_summary() {
    log_success "Cleanup completed successfully!"
    echo
    log_info "Summary of deleted resources:"
    echo "  IAM User: $IAM_USER_NAME"
    echo "  IAM Policy: $IAM_POLICY_NAME"
    echo "  Access Keys: All deleted"
    echo "  Local Files: Cleaned up"
    echo
    log_info "All AWS resources and local files have been removed."
    log_warning "If you have any Crossplane resources still running, you may need to delete them manually."
}

# Main execution
main() {
    log_info "Starting Crossplane IAM cleanup..."
    echo
    
    check_prerequisites
    echo
    
    load_resource_info
    echo
    
    validate_resources
    echo
    
    delete_access_keys
    echo
    
    delete_policy
    echo
    
    delete_iam_user
    echo
    
    cleanup_local_files
    echo
    
    display_summary
}

# Run main function
main "$@"
