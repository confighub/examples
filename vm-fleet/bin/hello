#!/bin/bash

# SSM Hello Script - Print hello.txt from instance
# Usage: ./hello <instance_name>

instance_name=$1
if [ -z "$instance_name" ]; then
  echo "Usage: $0 <instance_name>"
  echo "Example: $0 server1"
  exit 1
fi

# Get instance ID
instance_id=$(aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=$instance_name" \
  "Name=instance-state-name,Values=running" \
  --query 'Reservations[0].Instances[0].InstanceId' \
  --output text)

# Send command, wait for completion, and get output
command_id=$(aws ssm send-command \
  --instance-ids "$instance_id" \
  --document-name "AWS-RunShellScript" \
  --parameters "commands=['cat /home/ubuntu/hello.txt']" \
  --query "Command.CommandId" \
  --output text)

aws ssm wait command-executed --command-id "$command_id" --instance-id "$instance_id"
aws ssm get-command-invocation --command-id "$command_id" --instance-id "$instance_id" --query "StandardOutputContent" --output text
